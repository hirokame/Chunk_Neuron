function [FigA, FigB]=TouchSpikeAnalysis20170307(SpikeArray,RPegTouchAll,LPegTouchAll,fname,TrimStr)

% clear all;
% close all;
Bin=9;
% global StartTime FinishTime RPegTouchAll LPegTouchAll

%20170303 7-5
% StartTime=2459;
% FinishTime=167473;

% LpegTimeArray=[2829;3328;3833;4329;4837;5339;5843;6346;6847;7347;7849;8347;8848;9347;9847;10342;10842;11343;11843;12343;12848;13348;13854;14356;14858;15361;15862;16362;16862;17358;17862;18359;18858;19356;19864;20363;20863;21367;21871;22370;22872;23367;23871;24370;24868;25365;25865;26366;26865;27366;27865;28366;28870;29370;29870;30370;30871;31370;31871;32372;32870;33364;33872;34365;34864;35366;35865;36367;36871;37369;37869;38369;38868;39366;39870;40370;40868;41365;41870;42365;42864;43364;43870;44365;44869;45368;45869;46368;46868;47368;47870;48369;48865;49368;49865;50365;50864;51363;51865;52369;52868;53368;53869;54368;54870;55368;55868;56369;56869;57369;57868;58363;58869;59367;59867;60367;60872;61369;61873;62374;62871;63366;63871;64368;64868;65367;65866;66362;66867;67367;67868;68367;68871;69370;69872;70371;70867;71372;71870;72372;72865;73366;73868;74365;74866;75366;75867;76365;76870;77371;77871;78372;78871;79370;79871;80371;80870;81367;81865;82366;82866;83366;83865;84367;84871;85371;85871;86371;86869;87370;87869;88370;88870;89367;89870;90364;90864;91365;91869;92369;92870;93370;93869;94370;94870;95370;95870;96370;96871;97370;97870;98365;98865;99366;99869;100369;100868;101373;101873;102374;102869;103368;103874;104368;104868;105368;105866;106363;106864;107364;107865;108367;108868;109373;109869;110373;110868;111368;111868;112368;112867;113368;113867;114363;114867;115367;115872;116366;116869;117372;117873;118373;118871;119372;119870;120373;120867;121367;121868;122363;122867;123366;123866;124366;124872;125372;125871;126370;126870;127371;127870;128370;128871;129367;129866;130365;130865;131366;131871;132371;132871;133370;133876;134370;134870;135372;135871;136370;136871;137370;137866;138366;138865;139367;139866;140370;140870;141370;141869;142375;142869;143371;143869;144370;144869;145369;145869;146364;146864;147369;147870;148369;148869;149369;149875;150369;150874;151369;151868;152369;152869;153370;153869;154363;154870;155369;155869;156368;156874;157372;157872;158374;158874;159373;159873;160368;160868;161369;161867;162363;162867;163368;163867;164368;164873;165371;165872;166372;166871;167372;];
% RpegTimeArray=[2616;3055;3501;3948;4393;4843;5287;5733;6180;6630;7071;7518;7962;8403;8848;9293;9739;10186;10624;11071;11515;11964;12404;12852;13299;13744;14189;14638;15085;15530;15972;16422;16862;17307;17755;18198;18644;19085;19527;19975;20421;20867;21316;21761;22207;22654;23093;23539;23980;24430;24868;25316;25762;26201;26647;27094;27539;27980;28430;28876;29321;29760;30208;30653;31095;31538;31980;32425;32870;33316;33758;34205;34647;35092;35539;35983;36429;36871;37320;37765;38205;38650;39098;39538;39984;40429;40875;41315;41761;42207;42651;43092;43538;43982;44428;44873;45320;45760;46205;46657;47097;47537;47985;48429;48868;49314;49760;50206;50647;51090;51537;51981;52427;52872;53319;53764;54204;54655;55095;55540;55982;56427;56869;57313;57759;58205;58650;59092;59536;59984;60427;60872;61323;61764;62209;62654;63094;63537;63980;64431;64873;65318;65758;66204;66650;67090;67536;67981;68427;68871;69317;69765;70208;70655;71099;71540;71982;72430;72872;73318;73763;74207;74649;75095;75535;75984;76431;76876;77320;77761;78208;78653;79095;79540;79979;80430;80870;81315;81761;82207;82647;83093;83535;83985;84430;84871;85322;85762;86206;86651;87098;87538;87985;88429;88870;89315;89761;90206;90646;91094;91537;91982;92429;92874;93321;93766;94205;94656;95098;95543;95984;96429;96871;97314;97760;98207;98648;99093;99538;99983;100428;100872;101318;101763;102205;102650;103098;103541;103982;104428;104874;105319;105758;106203;106646;107092;107536;107987;108428;108879;109318;109762;110211;110654;111095;111540;111982;112427;112872;113318;113760;114204;114649;115094;115537;115986;116427;116876;117323;117763;118206;118652;119095;119540;119981;120430;120871;121316;121759;122204;122649;123094;123541;123986;124428;124877;125319;125761;126207;126653;127095;127540;127981;128429;128871;129316;129758;130207;130649;131095;131538;131984;132429;132874;133321;133767;134208;134653;135099;135538;135986;136430;136871;137315;137762;138205;138647;139093;139538;139984;140429;140876;141320;141761;142206;142651;143097;143538;143984;144429;144874;145315;145760;146205;146652;147093;147538;147983;148429;148874;149321;149765;150208;150652;151096;151538;151983;152428;152874;153319;153760;154206;154650;155095;155537;155982;156427;156874;157319;157763;158207;158657;159095;159540;159982;160427;160873;161317;161759;162205;162650;163096;163536;163982;164432;164873;165318;165763;166209;166654;167095;];

% SpikeArray=[-4782,-3940,708,723,761,1202,1247,2742,3128,3185,3214,3269,3689,3706,3730,4622,4695,5178,6515,6725,6763,6797,7228,7232,7282,7529,7740,8210,8223,8755,9228,9602,9680,9684,11237,11703,12257,12697,13226,15232,15274,16167,16789,17189,17206,17772,19770,20115,20162,20223,21223,21226,22215,22667,23793,24232,24238,24757,24795,24885,25219,25705,26330,27189,27198,27703,27740,27769,28305,28398,29152,29211,30275,31296,31350,32289,32348,32745,33251,33902,35219,35322,35727,36743,37267,37757,38864,39272,39741,39780,39838,40184,40734,41199,42704,42833,44252,44767,45218,45283,46313,46806,47800,48261,48269,48765,49104,49148,49168,49212,50297,50812,51017,51272,51333,52666,52771,52841,53225,53249,53284,55712,56742,56772,57231,57764,58225,58318,58345,58359,58846,60295,60822,62226,62438,62521,63303,63492,63718,63790,64184,64242,64280,65163,65236,66753,66785,66798,67820,67832,68275,68309,68323,68694,68755,68773,69275,70238,70780,71800,72178,72238,72789,73740,74329,75197,75757,75769,75802,76310,76427,76679,76774,77252,78789,80594,83824,84262,84731,85142,85268,85269,85280,86371,86381,86613,86771,86822,87294,87301,88293,88692,88793,89226,91198,91277,91295,91305,91339,91798,91838,92185,92200,92276,92772,93207,93601,94314,95247,95263,95298,95320,96732,96765,96787,98297,98673,98802,99257,99686,99754,99767,99794,99800,100724,102308,102694,102817,103287,105185,105282,105540,106257,106817,107272,107288,108238,108266,109167,109189,109254,110184,110621,111309,111849,111892,112196,112238,112257,112775,114898,115700,115793,116309,116687,116749,116795,116803,117761,118948,119266,120076,120710,120738,120775,121137,121196,121207,121226,121758,122764,123228,123283,123745,123769,123775,123789,123825,124257,124706,124739,125282,125727,127306,127768,127776,127807,128230,128231,128734,128747,129181,130266,130643,131245,131258,131328,131719,131720,131752,131799,132246,132757,132774,133225,133229,134231,135801,136269,136278,136282,138285,138731,139957,140043,140210,140252,140726,140800,141186,141189,141217,141444,143713,143730,143769,143918,144304,144754,145274,145629,146743,146796,147294,147323,147687,147783,147814,148283,148518,148645,148703,148737,148751,148766,149182,149272,150768,150798,151727,151754,152300,152304,152311,152731,152735,152975,153152,153203,153229,153695,153798,154752,155361,155725,155742,156773,158272,158813,158927,159279,159802,160321,160736,161182,161244,161252,161705,162820,163294,163770,163783,163811,164158,164264,165197,165205,165215,166764;];
% RPegTouchAll=[6606;7046;7518;8001;8432;8887;9342;9813;10154;10645;11048;11496;11991;12444;12922;13382;13695;14169;14624;15064;15539;15999;16463;16925;17352;17733;18189;18629;19077;19539;19991;20454;20955;21376;21728;22198;22654;23085;23555;24029;24460;24906;25372;25850;26184;26663;27084;27543;28014;28475;28929;29370;29727;30208;30637;31067;31548;31993;32454;32909;33355;33864;34171;34669;35070;35543;36004;36504;36955;37354;37741;38193;38661;39083;39548;39984;40445;40944;41369;41851;42196;42637;43068;43519;44033;44448;44923;45389;45727;46183;46646;47122;47529;47985;48477;48918;49375;49711;50191;50625;51072;51537;52003;52464;52933;53388;53725;54201;54630;55066;55550;55992;56489;56936;57359;57771;58177;58646;59110;59530;60012;60466;60963;61369;61748;62179;62620;63094;63537;64009;64470;64956;65342;65715;66189;66624;67109;67536;67986;68456;68955;69333;69708;70198;70678;71108;71535;72015;72466;72949;73366;73851;74179;74658;75114;75535;76048;76470;76910;77394;77728;78202;78623;79073;79565;79985;80488;80965;81404;81721;82188;82647;83118;83538;84077;84488;84939;85391;85747;86166;86638;87108;87558;87985;88479;88956;89354;89929;90170;90652;91086;91553;91988;92507;92960;93413;93747;94190;94650;95118;95561;96022;96447;96953;97329;97710;98190;98660;99079;99527;100016;100472;100908;101388;101735;102194;102631;103141;103591;104041;104458;104903;105329;105740;106180;106664;107085;107558;107997;108467;108932;109355;109873;110180;110621;111095;111560;112003;112491;112913;113357;113770;114189;114629;115135;115566;116031;116492;116922;117362;117744;118174;118624;119128;119565;120025;120451;120955;121387;121743;122154;122639;123090;123560;123990;124428;124930;125376;125727;126203;126629;127095;127540;128034;128481;128931;129367;129727;130169;130644;131113;131535;132045;132485;132940;133342;133736;134182;134614;135094;135520;135986;136425;136983;137339;137733;138192;138628;139074;139554;140030;140444;140949;141332;141737;142172;142656;143113;143558;144003;144458;144958;145339;145722;146176;146622;147063;147527;147983;148482;148899;149380;149725;150181;150622;151082;151562;151973;152518;152937;153344;153710;154170;154641;155082;155565;156027;156497;156958;157389;157739;158175;158641;159095;159550;160056;160531;160957;161317;161798;162180;162634;163105;163551;164035;164443;164952;165357;165714;166180;];
% LPegTouchAll=[6779;7347;7775;8233;8753;9219;9728;10352;10798;11299;11787;12264;12744;13273;13772;14328;14813;15305;15792;16277;16768;17268;17793;18386;18841;19296;19781;20282;20767;21253;21827;22365;22816;23324;23787;24281;24783;25243;25776;26385;26845;27312;27807;28291;28786;29270;29854;30335;30825;31334;31782;32287;32772;33270;33782;34330;34840;35320;35812;36279;36786;37271;37806;38349;38834;39301;39806;40271;40771;41240;41766;42359;42844;43301;43800;44296;44768;45282;45843;46390;46825;47314;47810;48300;48795;49250;49833;50319;50849;51309;51824;52305;52774;53273;53819;54348;54826;55308;55805;56282;56808;57269;57813;58338;58844;59317;59829;60269;60773;61248;61842;62378;62818;63322;63817;64298;64764;65299;65841;66373;66828;67318;67818;68286;68767;69284;69857;70355;70822;71309;71822;72292;72782;73268;73767;74342;74837;75317;75807;76296;76803;77268;77826;78350;78843;79314;79812;80297;80782;81246;81880;82345;82836;83321;83830;84296;84775;85286;85825;86324;86824;87325;87812;88297;88814;89261;89752;90340;90840;91315;91811;92295;92782;93286;93781;94345;94814;95316;95804;96301;96787;97275;97831;98350;98830;99324;99804;100285;100785;101285;101859;102388;102829;103303;103803;104276;104769;105329;105754;106338;106843;107299;107808;108293;108790;109259;109768;110373;110829;111319;111803;112273;112773;113273;113762;114343;114852;115307;115797;116304;116767;117249;117808;118336;118836;119323;119808;120283;120768;121284;121778;122317;122833;123306;123792;124292;124796;125282;125831;126360;126822;127306;127797;128293;128766;129267;129767;130356;130836;131306;131800;132288;132778;133266;133798;134336;134820;135307;135786;136276;136787;137277;137876;138356;138825;139310;139787;140282;140765;141277;141841;142425;142855;143310;143781;144280;144770;145280;145826;146385;146839;147300;147796;148291;148761;149264;149814;150329;150813;151314;151800;152295;152769;153256;153798;154398;154829;155320;155794;156295;156773;157264;157808;158348;158809;159314;159803;160295;160763;161263;161744;162332;162833;163313;163804;164283;164788;165258;165833;166352;];

% SpikeArray(SpikeArray<StartTime)=[];

RtoLtimeR=zeros(length(RPegTouchAll)-1,1);
LtoRtimeR=zeros(length(RPegTouchAll)-1,1);
RLRphase=zeros(length(RPegTouchAll)-1,1);
for n=1:length(RPegTouchAll)-1
    RTdur(n)=RPegTouchAll(n+1)-RPegTouchAll(n);
    SpikeNumR(n)=length(SpikeArray(SpikeArray>RPegTouchAll(n) & SpikeArray<=RPegTouchAll(n+1)));
    LTtimingR{n}=LPegTouchAll(LPegTouchAll>RPegTouchAll(n) & LPegTouchAll<=RPegTouchAll(n+1));
    LTnumR(n)=length(LTtimingR{n});
    if LTnumR(n)>=1
        RtoLtimeR(n)=LTtimingR{n}(1)-RPegTouchAll(n);
        LtoRtimeR(n)=RPegTouchAll(n+1)-LTtimingR{n}(1);
        RLRphase(n)=(LTtimingR{n}(1)-RPegTouchAll(n))/(RPegTouchAll(n+1)-RPegTouchAll(n));
    end
end

RTdurSP=zeros(1,Bin);
RLRphaseSP=zeros(1,Bin);
RtoLtimeRSP=zeros(1,Bin);
LtoRtimeRSP=zeros(1,Bin);
for n=1:Bin
%    A= RTdur(RTdur>10*(n-1) & RTdur<10*n);
%    B=find(RTdur>10*(n-1) & RTdur<10*n);
    SP1=SpikeNumR(RTdur>1000*(1/Bin)*(n-1) & RTdur<=1000*(1/Bin)*n);
    if length(SP1)>=2;RTdurSP(n)=sum(SP1)/length(SP1);end
    SP2=SpikeNumR(RLRphase>(1/Bin)*(n-1) & RLRphase<=(1/Bin)*n);
    if length(SP2)>=2;RLRphaseSP(n)=sum(SP2)/length(SP2);end
    SP3=SpikeNumR(RtoLtimeR>500*(1/Bin)*(n-1) & RtoLtimeR<=500*(1/Bin)*n);
    if length(SP3)>=2;RtoLtimeRSP(n)=sum(SP3)/length(SP3);end
    SP4=SpikeNumR(LtoRtimeR>500*(1/Bin)*(n-1) & LtoRtimeR<=500*(1/Bin)*n);
    if length(SP4)>=2;LtoRtimeRSP(n)=sum(SP4)/length(SP4);end
end
RTdurSP(isnan(RTdurSP))=0;
RLRphaseSP(isnan(RLRphaseSP))=0;
RtoLtimeRSP(isnan(RtoLtimeRSP))=0;
LtoRtimeRSP(isnan(LtoRtimeRSP))=0;

RtoLtimeL=zeros(length(LPegTouchAll)-1,1);
LtoRtimeL=zeros(length(LPegTouchAll)-1,1);
LRLphase=zeros(length(LPegTouchAll)-1,1);
for n=1:length(LPegTouchAll)-1
    LTdur(n)=LPegTouchAll(n+1)-LPegTouchAll(n);
    SpikeNumL(n)=length(SpikeArray(SpikeArray>LPegTouchAll(n) & SpikeArray<=LPegTouchAll(n+1)));
    RTtimingL{n}=RPegTouchAll(RPegTouchAll>LPegTouchAll(n) & RPegTouchAll<=LPegTouchAll(n+1));
    RTnumL(n)=length(RTtimingL{n});
    if RTnumL(n)>=1
        LtoRtimeL(n)=RTtimingL{n}(1)-LPegTouchAll(n);
        RtoLtimeL(n)=LPegTouchAll(n+1)-RTtimingL{n}(1);
        LRLphase(n)=(RTtimingL{n}(1)-LPegTouchAll(n))/(LPegTouchAll(n+1)-LPegTouchAll(n));
    end
end

LTdurSP=zeros(1,Bin);
LRLphaseSP=zeros(1,Bin);
LtoRtimeLSP=zeros(1,Bin);
RtoLtimeLSP=zeros(1,Bin);
for n=1:Bin
%    A= RTdur(RTdur>10*(n-1) & RTdur<10*n);
%    B=find(RTdur>10*(n-1) & RTdur<10*n);
    SP1=SpikeNumL(LTdur>1000*(1/Bin)*(n-1) & LTdur<=1000*(1/Bin)*n);
    if length(SP1)>=2;LTdurSP(n)=sum(SP1)/length(SP1);end
    SP2=SpikeNumL(LRLphase>(1/Bin)*(n-1) & LRLphase<=(1/Bin)*n);
    if length(SP2)>=2;LRLphaseSP(n)=sum(SP2)/length(SP2);end
    SP3=SpikeNumL(LtoRtimeL>500*(1/Bin)*(n-1) & LtoRtimeL<=500*(1/Bin)*n);
    if length(SP3)>=2;LtoRtimeLSP(n)=sum(SP3)/length(SP3);end
    SP4=SpikeNumL(RtoLtimeL>500*(1/Bin)*(n-1) & RtoLtimeL<=500*(1/Bin)*n);
    if length(SP4)>=2;RtoLtimeLSP(n)=sum(SP4)/length(SP4);end
end
LTdurSP(isnan(LTdurSP))=0;
LRLphaseSP(isnan(LRLphaseSP))=0;
LtoRtimeLSP(isnan(LtoRtimeLSP))=0;
RtoLtimeLSP(isnan(RtoLtimeLSP))=0;

if sum(RTdurSP)~=0
    FigA=figure
    subplot(2,4,1)
    RTdurSP
    plot(RTdurSP);ylim([0 max(RTdurSP)]);
    title('Duration R');
    subplot(2,4,2)
    plot(RLRphaseSP);ylim([0 max(RLRphaseSP)]);
    title('RLR Phase');
    subplot(2,4,3)
    plot(RtoLtimeRSP);ylim([0 max(RtoLtimeRSP)]);
    title('RtoLtime in R');
    subplot(2,4,4)
    plot(LtoRtimeRSP);ylim([0 max(LtoRtimeRSP)]);
    title('LtoRtime in R');
    subplot(2,4,5)
    plot(LTdurSP);ylim([0 max(LTdurSP)]);
    title('Duration L');
    subplot(2,4,6)
    plot(LRLphaseSP);ylim([0 max(LRLphaseSP)]);
    title('LRL Phase');
    subplot(2,4,7)
    plot(LtoRtimeLSP);ylim([0 max(LtoRtimeLSP)]);
    title('LtoRtime in L');
    subplot(2,4,8)
    plot(RtoLtimeLSP);ylim([0 max(RtoLtimeLSP)]);
    title('RtoLtime in L');
    xlabel([fname,' ',TrimStr((1:end-1))]);



    FigB=figure
    subplot(2,4,1)
    plot(RTdur,SpikeNumR,' ob');xlim([0 1000]);
    title('Duration R');
    subplot(2,4,2)
    plot(RLRphase,SpikeNumR,' xr');
    title('RLR Phase');
    subplot(2,4,3)
    plot(RtoLtimeR,SpikeNumR,' *g');xlim([0 1000]);
    title('RtoLtime in R');
    subplot(2,4,4)
    plot(LtoRtimeR,SpikeNumR,' *m');xlim([0 1000]);
    title('LtoRtime in R');
    subplot(2,4,5)
    plot(LTdur,SpikeNumL,' ob');xlim([0 1000]);
    title('Duration L');
    subplot(2,4,6)
    plot(LRLphase,SpikeNumL,' xr');
    title('LRL Phase');
    subplot(2,4,7)
    plot(LtoRtimeL,SpikeNumL,' *g');xlim([0 1000]);
    title('LtoRtime in L');
    subplot(2,4,8)
    plot(RtoLtimeL,SpikeNumL,' *m');xlim([0 1000]);
    title('RtoLtime in L');
    xlabel([fname,' ',TrimStr((1:end-1))]);
else
    FigA=0;
    FigB=0;
end
